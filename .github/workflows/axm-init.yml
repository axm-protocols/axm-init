name: axm-init audit

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  audit:
    name: AXM Audit & Badge
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v7
      - run: uv python install 3.12
      - run: uv sync --all-groups

      - name: Run AXM Audit
        id: audit
        run: |
          RESULT=$(uv run python -m axm_init.cli audit . --json)
          SCORE=$(echo "$RESULT" | jq '.score')
          GRADE=$(echo "$RESULT" | jq -r '.grade')
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          echo "grade=$GRADE" >> "$GITHUB_OUTPUT"
          echo "ðŸ“‹ AXM Audit: Score $SCORE/100 â€” Grade $GRADE"

      - name: Choose badge color
        id: color
        run: |
          SCORE=${{ steps.audit.outputs.score }}
          if [ "$SCORE" -ge 95 ]; then COLOR="brightgreen"
          elif [ "$SCORE" -ge 80 ]; then COLOR="green"
          elif [ "$SCORE" -ge 60 ]; then COLOR="yellow"
          else COLOR="red"; fi
          echo "color=$COLOR" >> "$GITHUB_OUTPUT"

      - name: Generate badge JSON
        run: |
          mkdir -p badges
          cat > badges/axm-init.json <<EOF
          {
            "schemaVersion": 1,
            "label": "axm-init",
            "message": "${{ steps.audit.outputs.score }}%",
            "color": "${{ steps.color.outputs.color }}",
            "namedLogo": "python",
            "style": "flat"
          }
          EOF

      - name: Push badge to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./badges
          destination_dir: badges
          keep_files: true
          commit_message: "badge: update axm-init score to ${{ steps.audit.outputs.score }}/100"
